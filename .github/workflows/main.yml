name: Create Resource Issue

on:
  push:
    branches: [main]

jobs:
  create_issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install ruamel.yaml
        run: pip install ruamel.yaml

      - name: Parse template.yml
        run: |
          python - <<EOF
          import ruamel.yaml
          import os
          import requests
          import json

          with open('template.yml', 'r') as file:
              template = ruamel.yaml.YAML().load(file)

          resources = template.get('Resources', {})
          resource_names = list(resources.keys())

          issue_title = 'AWS Resources in CloudFormation Template'
          issue_body = 'The following AWS resources are defined in the CloudFormation template:\n\n'
          for resource in resource_names:
              issue_body += f'- {resource}\n'

          headers = {
              'Authorization': f'token ${{ secrets.GITHUB_TOKEN }}',
              'Accept': 'application/vnd.github.v3+json'
          }

          data = {
              'title': issue_title,
              'body': issue_body
          }

          response = requests.post(
              f'https://api.github.com/repos/{os.environ["GITHUB_REPOSITORY"]}/issues',
              headers=headers,
              data=json.dumps(data)
          )

          if response.status_code == 201:
              print('Issue created successfully.')
          else:
              print(f'Failed to create issue. Status code: {response.status_code}, Error: {response.text}')
          EOF
