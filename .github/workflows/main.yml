name: Create Issue with AWS Resources

on:
  workflow_dispatch: null

jobs:
  create_issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'

      - name: Instalar dependencias
        run: pip install ruamel.yaml

      - name: Executar listar-recursos.py
        run: python listar-recursos.py

      - name: Recupera o arquivo resources.txt
        id: read-resources
        run: echo "::set-output name=resources::$(cat resources.txt)"  
           
      - name: Create issue using REST API
        run: |
          curl --request POST \
          --url https://api.github.com/repos/${{ github.repository }}/issues \
          --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
          --header 'content-type: application/json' \
          --data '{
            "title": "Lista os recursos de infra",
            "body": "**${{ github.workflow }}**\n\nRecursos:\n\n${{ steps.read-resources.outputs.resources }}"
            }' \
          --fail